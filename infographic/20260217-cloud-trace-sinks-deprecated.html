<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cloud Trace: トレースシンク機能の非推奨化</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap');

    /* Google Cloud Light Theme Base Styles */
    :root {
      --gc-blue: #4285F4;
      --gc-red: #EA4335;
      --gc-yellow: #FBBC04;
      --gc-green: #34A853;
      --gc-blue-900: #174EA6;
      --gc-blue-800: #185ABC;
      --gc-blue-700: #1967D2;
      --gc-blue-600: #1A73E8;
      --gc-blue-500: #4285F4;
      --gc-blue-300: #669DF6;
      --gc-blue-200: #8AB4F8;
      --gc-blue-100: #AECBFA;
      --gc-blue-50: #E8F0FE;
      --gc-on-surface: #202124;
      --gc-on-surface-variant: #5F6368;
      --gc-outline: #80868B;
      --gc-surface: #FFFFFF;
      --gc-surface-container-lowest: #F8F9FA;
      --gc-surface-container-low: #F1F3F4;
      --gc-surface-container: #E8EAED;
      --gc-outline-variant: #DADCE0;
      --gc-blue-tint: #E8F0FE;
      --gc-green-tint: #E6F4EA;
      --gc-red-tint: #FCE8E6;
      --gc-yellow-tint: #FEF7E0;
      --gc-purple-tint: #F3E8FD;
      --gc-teal-tint: #E0F7FA;
      --gc-purple: #A142F4;
      --gc-teal: #00BCD4;
      --gc-orange: #FF6D00;
    }

    * { box-sizing: border-box; }

    body {
      background-color: var(--gc-surface);
      font-family: 'Google Sans', 'Noto Sans JP', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      color: var(--gc-on-surface-variant);
      font-size: 16px;
      line-height: 1.7;
      padding: 20px;
      margin: 0;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      width: 100%;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      flex-wrap: wrap;
      padding-bottom: 16px;
      border-bottom: 3px solid var(--gc-blue-600);
    }

    h1, .title {
      font-size: 36px;
      font-weight: 700;
      color: var(--gc-on-surface);
      margin: 0;
    }

    h2, .section-title {
      font-size: 24px;
      font-weight: 600;
      color: var(--gc-on-surface);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--gc-blue-600);
    }

    h3 {
      font-size: 20px;
      font-weight: 600;
      color: var(--gc-on-surface);
      margin: 20px 0 12px 0;
    }

    .subtitle {
      font-size: 16px;
      color: var(--gc-outline);
    }

    .section {
      background: var(--gc-surface-container-low);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid var(--gc-outline-variant);
    }

    .highlight {
      background-color: var(--gc-blue-50);
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      color: var(--gc-blue-800);
      border-bottom: 2px solid var(--gc-blue-600);
    }

    .card {
      background: var(--gc-surface);
      border-radius: 12px;
      padding: 20px;
      margin: 12px 0;
      border-left: 4px solid var(--gc-blue-600);
      box-shadow: 0 1px 3px rgba(60, 64, 67, 0.12), 0 1px 2px rgba(60, 64, 67, 0.08);
    }

    .card-red {
      border-left-color: var(--gc-red);
    }

    .card-green {
      border-left-color: var(--gc-green);
    }

    .card-orange {
      border-left-color: var(--gc-orange);
    }

    .icon-text {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin: 8px 0;
      color: var(--gc-on-surface-variant);
    }

    .arrow {
      color: var(--gc-blue-600);
      font-size: 20px;
    }

    .gc-link {
      color: var(--gc-blue-600);
      text-decoration: none;
    }

    .gc-link:hover {
      color: var(--gc-blue-800);
      text-decoration: underline;
    }

    .badge,
    .badge-ga,
    .badge-preview,
    .badge-deprecated {
      display: inline-block;
      color: #FFFFFF;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.25px;
      margin: 4px 8px 4px 0;
    }

    .badge {
      background: var(--gc-blue-600);
    }

    .badge-ga {
      background: var(--gc-green);
      color: #FFFFFF;
    }

    .badge-preview {
      background: var(--gc-orange);
      color: #FFFFFF;
    }

    .badge-deprecated {
      background: var(--gc-red);
      color: #FFFFFF;
    }

    .flow-diagram {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
      margin: 24px 0;
    }

    .flow-step {
      background: var(--gc-surface);
      border: 2px solid var(--gc-blue-600);
      border-radius: 12px;
      padding: 12px 20px;
      text-align: center;
      min-width: 100px;
      color: var(--gc-on-surface);
      box-shadow: 0 1px 3px rgba(60, 64, 67, 0.12);
    }

    .flow-arrow {
      color: var(--gc-blue-600);
      font-size: 24px;
      font-weight: bold;
    }

    /* Before/After comparison */
    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    @media (max-width: 768px) {
      .comparison-grid {
        grid-template-columns: 1fr;
      }
    }

    .comparison-before {
      background: var(--gc-red-tint);
      border: 2px solid var(--gc-red);
      border-radius: 12px;
      padding: 20px;
    }

    .comparison-after {
      background: var(--gc-green-tint);
      border: 2px solid var(--gc-green);
      border-radius: 12px;
      padding: 20px;
    }

    .comparison-before h3,
    .comparison-after h3 {
      margin-top: 0;
      font-size: 18px;
    }

    .comparison-before ul,
    .comparison-after ul {
      margin: 8px 0;
      padding-left: 20px;
    }

    .comparison-before li,
    .comparison-after li {
      margin: 6px 0;
      font-size: 14px;
    }

    /* Feature cards grid */
    .feature-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin: 16px 0;
    }

    .feature-card {
      background: var(--gc-surface);
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid var(--gc-blue-600);
      box-shadow: 0 1px 3px rgba(60, 64, 67, 0.12), 0 1px 2px rgba(60, 64, 67, 0.08);
    }

    .feature-card h4 {
      margin: 0 0 8px 0;
      color: var(--gc-on-surface);
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .feature-card p,
    .feature-card ul {
      margin: 4px 0;
      font-size: 14px;
    }

    .feature-card ul {
      padding-left: 20px;
    }

    .feature-card li {
      margin: 4px 0;
    }

    /* Usecase cards */
    .usecase-card {
      background: var(--gc-blue-tint);
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      border: 1px solid var(--gc-blue-200);
    }

    .usecase-card h4 {
      margin: 0 0 8px 0;
      color: var(--gc-blue-900);
      font-size: 17px;
    }

    .usecase-card p {
      margin: 4px 0;
      font-size: 14px;
    }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--gc-blue-600), var(--gc-blue-800));
      color: var(--gc-surface);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    /* Table styles */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--gc-outline-variant);
    }

    th {
      background: var(--gc-blue-50);
      color: var(--gc-blue-900);
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      border-bottom: 2px solid var(--gc-blue-200);
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--gc-outline-variant);
      font-size: 14px;
    }

    tr:nth-child(even) {
      background: var(--gc-surface-container-lowest);
    }

    tr:hover {
      background: var(--gc-blue-50);
    }

    /* Note/Warning boxes */
    .note-box {
      background: var(--gc-blue-tint);
      border-left: 4px solid var(--gc-blue-600);
      padding: 16px 20px;
      border-radius: 0 12px 12px 0;
      margin: 16px 0;
    }

    .warning-box {
      background: var(--gc-yellow-tint);
      border-left: 4px solid var(--gc-yellow);
      padding: 16px 20px;
      border-radius: 0 12px 12px 0;
      margin: 16px 0;
    }

    .error-box {
      background: var(--gc-red-tint);
      border-left: 4px solid var(--gc-red);
      padding: 16px 20px;
      border-radius: 0 12px 12px 0;
      margin: 16px 0;
    }

    .success-box {
      background: var(--gc-green-tint);
      border-left: 4px solid var(--gc-green);
      padding: 16px 20px;
      border-radius: 0 12px 12px 0;
      margin: 16px 0;
    }

    /* Code blocks */
    .code-block {
      background: #1E1E1E;
      border-radius: 8px;
      overflow: hidden;
      margin: 16px 0;
    }

    .code-header {
      background: #2D2D2D;
      padding: 8px 16px;
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }

    .code-lang {
      color: #9CDCFE;
      font-weight: bold;
    }

    .code-title {
      color: #AAAAAA;
    }

    .code-block pre {
      margin: 0;
      padding: 0;
      overflow-x: auto;
      background: #1E1E1E;
      border-radius: 0;
    }

    .code-block code {
      font-family: 'Roboto Mono', 'Source Code Pro', 'Courier New', monospace;
      font-size: 15px;
      line-height: 1.6;
      padding: 16px !important;
    }

    pre:not(.mermaid) {
      background: #1E1E1E;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Roboto Mono', 'Source Code Pro', 'Courier New', monospace;
      font-size: 15px;
      line-height: 1.6;
      overflow-x: auto;
      color: #E8E8E8;
      margin: 16px 0;
    }

    pre code {
      background: none;
      border: none;
      padding: 0;
      font-size: inherit;
      color: inherit;
    }

    code:not(pre code) {
      background: var(--gc-surface-container-low);
      border: 1px solid var(--gc-outline-variant);
      border-radius: 4px;
      padding: 2px 6px;
      font-family: 'Roboto Mono', 'Source Code Pro', 'Courier New', monospace;
      font-size: 0.9em;
      color: var(--gc-blue-900);
    }

    /* Mermaid container */
    .mermaid-container {
      background: #FFFFFF;
      border-radius: 12px;
      padding: 24px;
      margin: 20px 0;
      border: 2px solid rgba(66, 133, 244, 0.3);
      overflow-x: auto;
    }

    .mermaid {
      display: flex;
      justify-content: center;
    }

    /* Migration steps */
    .step-list {
      counter-reset: step-counter;
      list-style: none;
      padding: 0;
    }

    .step-list li {
      counter-increment: step-counter;
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin: 16px 0;
      padding: 16px;
      background: var(--gc-surface);
      border-radius: 12px;
      border: 1px solid var(--gc-outline-variant);
    }

    .step-list li::before {
      content: counter(step-counter);
      background: var(--gc-blue-600);
      color: #FFFFFF;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      flex-shrink: 0;
    }

    .step-content {
      flex: 1;
    }

    .step-content h4 {
      margin: 0 0 8px 0;
      color: var(--gc-on-surface);
      font-size: 16px;
    }

    .step-content p {
      margin: 4px 0;
      font-size: 14px;
    }

    /* Two column grid for merits/demerits */
    .two-col-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 16px 0;
    }

    @media (max-width: 768px) {
      .two-col-grid {
        grid-template-columns: 1fr;
      }
      h1 {
        font-size: 28px;
      }
    }

    /* Related services tags */
    .service-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 16px 0;
    }

    .service-tag {
      background: var(--gc-blue-50);
      border: 1px solid var(--gc-blue-200);
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 14px;
      color: var(--gc-blue-900);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Links list */
    .links-list {
      list-style: none;
      padding: 0;
    }

    .links-list li {
      margin: 8px 0;
      padding: 8px 0;
      border-bottom: 1px solid var(--gc-outline-variant);
      font-size: 14px;
    }

    .links-list li:last-child {
      border-bottom: none;
    }

    .links-list a {
      color: var(--gc-blue-600);
      text-decoration: none;
      word-break: break-all;
    }

    .links-list a:hover {
      text-decoration: underline;
      color: var(--gc-blue-800);
    }

    footer {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--gc-outline-variant);
      font-size: 12px;
      color: var(--gc-outline);
    }

    footer a {
      color: var(--gc-blue-600);
      text-decoration: underline;
      word-break: break-all;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
</head>
<body>
  <div class="container">

    <!-- Header -->
    <div class="header">
      <div>
        <h1>Cloud Trace: トレースシンク機能の非推奨化</h1>
        <div style="margin-top: 8px;">
          <span class="badge badge-deprecated">Deprecated</span>
          <span class="badge">Cloud Trace</span>
          <span class="badge" style="background: var(--gc-green);">Log Analytics</span>
        </div>
      </div>
      <div class="subtitle">2026-02-17</div>
    </div>

    <!-- Overview -->
    <div class="section">
      <h2>&#x1F4CB; 概要</h2>
      <p>
        2026 年 2 月 18 日より、Cloud Trace の<span class="highlight">トレースシンク (Trace Sinks)</span> 機能が非推奨 (Deprecated) となった。トレースシンクは、Cloud Trace に取り込まれたトレーススパンを BigQuery データセットにエクスポートするための機能で、Cloud Trace API (v2beta1) または Google Cloud CLI を使用してシンクを作成・管理していた。この機能はこれまで Beta ステータスのまま提供されていた。
      </p>
      <p>
        Google Cloud は、トレースシンクに代わる移行先として <span class="highlight">Log Analytics</span> ページの利用を推奨している。Log Analytics は SQL ベースのクエリインターフェースを提供し、トレースデータとログデータの両方を統合的にクエリ・分析できる。
      </p>

      <div class="error-box">
        <strong>&#x26A0;&#xFE0F; 影響範囲:</strong> Cloud Trace を使用してトレースデータを BigQuery にエクスポートしているすべてのユーザーに影響する。特に、トレースシンクを設定してトレーススパンを BigQuery にストリーミングエクスポートしているプロジェクトでは、早急に Log Analytics への移行を計画する必要がある。
      </div>

      <!-- Before/After -->
      <div class="comparison-grid">
        <div class="comparison-before">
          <h3>&#x274C; アップデート前の課題</h3>
          <ul>
            <li>トレースシンクは Beta ステータスのまま提供されており、限定的なサポートしか受けられなかった</li>
            <li>専用のシンクの作成、宛先データセットの設定、サービスアカウントへの権限付与など複雑な構成が必要だった</li>
            <li>リトライ機構やスロットリング機構が未実装で、BigQuery クォータ超過時にスパンがエクスポートされない可能性があった</li>
            <li>Cloud Trace API で取り込まれたトレーススパンのみがエクスポート対象で、Google Cloud サービスや Telemetry API 経由のスパンは非サポート</li>
            <li>トレースデータとログデータを統合的に分析する手段が限られていた</li>
          </ul>
        </div>
        <div class="comparison-after">
          <h3>&#x2705; アップデート後の改善</h3>
          <ul>
            <li>Log Analytics を使用することで、シンクの作成・管理が不要になり、設定の簡素化が実現される</li>
            <li>SQL ベースの統一インターフェースで、トレースデータとログデータの両方をクエリ可能</li>
            <li>linked BigQuery dataset を作成することで、BigQuery Studio や Looker Studio からのクエリ、他のビジネスデータとの JOIN が可能</li>
            <li>Query Builder インターフェースにより、メニュー選択だけでクエリを構築可能で、技術的な敷居が低下</li>
            <li>クエリ結果をチャートとして可視化し、カスタムダッシュボードに保存可能</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Architecture Diagram (Mermaid from source) -->
    <div class="section">
      <h2>&#x1F3D7;&#xFE0F; アーキテクチャ図</h2>
      <p>従来のシンクベースのエクスポート方式と、移行後の Log Analytics を使用した方式の比較を示す。移行後は Observability バケットに格納されたトレースデータを Log Analytics から直接クエリでき、必要に応じて linked BigQuery dataset を作成して外部サービスからアクセスすることも可能。</p>
      <div class="mermaid-container">
        <pre class="mermaid">
flowchart LR
    subgraph before["従来: シンクベースのエクスポート"]
        A1["Cloud Trace\nAPI"] -->|"スパン取り込み"| B1[("Cloud Trace")]
        B1 -->|"シンク経由\nストリーミング"| C1[("BigQuery\nデータセット")]
        C1 -->|"SQL クエリ"| D1["BigQuery\nコンソール"]
    end

    subgraph after["移行後: Log Analytics"]
        A2["Cloud Trace\nAPI"] -->|"スパン取り込み"| B2[("_Trace バケット\nObservability")]
        B2 -->|"直接クエリ"| D2["Log Analytics\nSQL インターフェース"]
        B2 -.->|"linked dataset\n(オプション)"| C2[("BigQuery\nlinked dataset")]
        C2 -.->|"JOIN / 外部アクセス"| E2["BigQuery Studio\nLooker Studio"]
    end

    before ~~~ after
        </pre>
      </div>
    </div>

    <!-- Key Features -->
    <div class="section">
      <h2>&#x1F527; サービスアップデートの詳細 - 主要機能</h2>

      <div class="feature-grid">
        <div class="feature-card" style="border-left-color: var(--gc-red);">
          <h4>&#x1F6AB; トレースシンクの非推奨化</h4>
          <ul>
            <li>2026 年 2 月 18 日以降、トレースシンクは非推奨となる</li>
            <li>既存のシンクは引き続き動作するが、新規作成は推奨されない</li>
            <li>Cloud Trace API v2beta1 の <code>TracingConfigService</code> (CreateTraceSink, DeleteTraceSink, GetTraceSink, ListTraceSinks, UpdateTraceSink) が対象</li>
          </ul>
        </div>

        <div class="feature-card" style="border-left-color: var(--gc-green);">
          <h4>&#x1F504; Log Analytics への移行パス</h4>
          <ul>
            <li>Log Analytics ページの <code>_Trace.Spans._AllSpans</code> ビューを使用してトレースデータをクエリ可能</li>
            <li>SQL クエリ言語 (BigQuery Standard SQL) をそのまま利用できる</li>
            <li>Query Builder インターフェースによるメニュー選択でのクエリ構築にも対応</li>
            <li>クエリ結果はテーブルまたはチャートで表示でき、カスタムダッシュボードに保存可能</li>
          </ul>
        </div>

        <div class="feature-card" style="border-left-color: var(--gc-blue-300);">
          <h4>&#x1F517; linked BigQuery dataset によるクエリ</h4>
          <ul>
            <li>Log Analytics から直接クエリする場合は linked dataset は不要</li>
            <li>BigQuery Studio や Looker Studio からトレースデータをクエリする場合に linked dataset が必要</li>
            <li>他のビジネスデータとトレースデータを JOIN する場合にも linked dataset を使用</li>
            <li>BigQuery reserved slots で Log Analytics のクエリパフォーマンスを向上させる場合にも必要</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Technical Specifications -->
    <div class="section">
      <h2>&#x1F4D0; 技術仕様</h2>

      <h3>&#x1F4CA; スキーマの比較 (レガシーシンク vs Log Analytics)</h3>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>項目</th>
              <th>Log Analytics</th>
              <th>レガシーシンク</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Trace ID</td>
              <td><code>trace_id</code></td>
              <td><code>extendedFields.traceId</code></td>
            </tr>
            <tr>
              <td>Span ID</td>
              <td><code>span_id</code></td>
              <td><code>span.spanId</code></td>
            </tr>
            <tr>
              <td>Parent span ID</td>
              <td><code>parent_span_id</code></td>
              <td><code>span.parentSpanId</code></td>
            </tr>
            <tr>
              <td>Span name</td>
              <td><code>name</code></td>
              <td><code>span.displayName.value</code></td>
            </tr>
            <tr>
              <td>Span kind</td>
              <td><code>kind</code> (OpenTelemetry SpanKind)</td>
              <td><code>span.spanKind</code> (Cloud Trace API SpanKind)</td>
            </tr>
            <tr>
              <td>Span start time</td>
              <td><code>start_time</code></td>
              <td><code>span.startTime</code></td>
            </tr>
            <tr>
              <td>Span end time</td>
              <td><code>end_time</code></td>
              <td><code>span.endTime</code></td>
            </tr>
            <tr>
              <td>Attributes</td>
              <td><code>attributes["key"]</code>, <code>resource.attributes["key"]</code> (JSON 型)</td>
              <td><code>span.attributes.attributeMap.KEY</code></td>
            </tr>
          </tbody>
        </table>
      </div>

      <h3>&#x1F512; 必要な IAM ロール</h3>
      <p>Log Analytics への移行およびクエリ実行には以下のロールが必要となる。</p>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>ロール</th>
              <th>用途</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>roles/cloudtrace.admin</code></td>
              <td>Cloud Trace の管理権限</td>
            </tr>
            <tr>
              <td><code>roles/observability.editor</code></td>
              <td>Observability リソースの編集権限</td>
            </tr>
            <tr>
              <td><code>roles/bigquery.user</code></td>
              <td>BigQuery ジョブの実行権限</td>
            </tr>
            <tr>
              <td><code>roles/observability.viewAccessor</code></td>
              <td>Observability ビューへのアクセス権限</td>
            </tr>
            <tr>
              <td><code>roles/observability.analyticsUser</code></td>
              <td>クエリの保存・実行権限</td>
            </tr>
            <tr>
              <td><code>roles/logging.viewer</code></td>
              <td>ログの閲覧権限</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Setup / Migration Steps -->
    <div class="section">
      <h2>&#x1F6E0;&#xFE0F; 設定方法 - 移行手順</h2>

      <div class="note-box">
        <strong>&#x1F4DD; 前提条件:</strong> Google Cloud プロジェクトで課金が有効であること / Observability API が有効化されていること / 上記 IAM ロールが付与されていること
      </div>

      <ol class="step-list">
        <li>
          <div class="step-content">
            <h4>Log Analytics でトレースデータへのアクセスを確認</h4>
            <p>Google Cloud コンソールで <strong>Log Analytics</strong> ページに移動し、<strong>Views</strong> メニューの <strong>Traces</strong> セクションから <code>_Trace.Spans._AllSpans</code> を選択する。</p>
            <div class="code-block">
              <div class="code-header">
                <span class="code-lang">SQL</span>
                <span class="code-title">Log Analytics でのクエリ例: FROM 句のフォーマット</span>
              </div>
              <pre><code class="language-sql">SELECT *
FROM `PROJECT_ID.us._Trace.Spans._AllSpans`
LIMIT 100</code></pre>
            </div>
          </div>
        </li>
        <li>
          <div class="step-content">
            <h4>既存のトレースシンクを確認・削除</h4>
            <div class="code-block">
              <div class="code-header">
                <span class="code-lang">Bash</span>
                <span class="code-title">gcloud CLI によるシンク管理</span>
              </div>
              <pre><code class="language-bash"># 既存のトレースシンクを一覧表示
gcloud alpha trace sinks list

# トレースシンクを削除
gcloud alpha trace sinks delete SINK_NAME</code></pre>
            </div>
          </div>
        </li>
        <li>
          <div class="step-content">
            <h4>(オプション) linked BigQuery dataset を作成</h4>
            <p>BigQuery Studio や Looker Studio からトレースデータをクエリする場合、または他のデータセットと JOIN する場合は、linked BigQuery dataset を作成する。</p>
          </div>
        </li>
        <li>
          <div class="step-content">
            <h4>不要な BigQuery データセットを削除</h4>
            <p>シンクによって作成された BigQuery データセットが不要になった場合は削除する。</p>
            <div class="code-block">
              <div class="code-header">
                <span class="code-lang">Bash</span>
                <span class="code-title">BigQuery データセットの削除</span>
              </div>
              <pre><code class="language-bash"># BigQuery データセットの削除
bq rm -r -d PROJECT_ID:DATASET_ID</code></pre>
            </div>
          </div>
        </li>
      </ol>
    </div>

    <!-- Merits -->
    <div class="section">
      <h2>&#x2705; メリット</h2>
      <div class="two-col-grid">
        <div>
          <h3>&#x1F4BC; ビジネス面</h3>
          <div class="card card-green">
            <div class="icon-text">
              <span>&#x2192;</span>
              <span><strong>運用コストの削減:</strong> シンクの管理・監視が不要になり、運用負荷が軽減される。シンクベースのエクスポートでは BigQuery Streaming API の料金が発生していたが、Log Analytics からの直接クエリではその料金が不要になる</span>
            </div>
          </div>
          <div class="card card-green">
            <div class="icon-text">
              <span>&#x2192;</span>
              <span><strong>統合的な可視化:</strong> トレースデータとログデータを同一の SQL インターフェースで分析でき、インシデント対応やパフォーマンス分析の効率が向上する</span>
            </div>
          </div>
        </div>
        <div>
          <h3>&#x2699;&#xFE0F; 技術面</h3>
          <div class="card card-green">
            <div class="icon-text">
              <span>&#x2192;</span>
              <span><strong>シンプルなアーキテクチャ:</strong> 中間的なエクスポートパイプラインが不要になり、システム構成がシンプルになる</span>
            </div>
          </div>
          <div class="card card-green">
            <div class="icon-text">
              <span>&#x2192;</span>
              <span><strong>OpenTelemetry 準拠のスキーマ:</strong> Log Analytics のスキーマは OpenTelemetry の SpanKind に準拠しており、業界標準との整合性が向上する</span>
            </div>
          </div>
          <div class="card card-green">
            <div class="icon-text">
              <span>&#x2192;</span>
              <span><strong>柔軟なクエリオプション:</strong> Query Builder によるメニューベースのクエリ構築、SQL エディタによるカスタムクエリ、システム定義クエリのロードなど多様な方法でデータにアクセス可能</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Demerits / Limitations -->
    <div class="section">
      <h2>&#x26A0;&#xFE0F; デメリット・制約事項</h2>
      <div class="two-col-grid">
        <div>
          <h3>&#x1F6AB; 制限事項</h3>
          <div class="card card-red">
            <div class="icon-text">
              <span>&#x274C;</span>
              <span>Log Analytics のトレースクエリ機能は現在 <strong>Preview</strong> ステータスであり、GA ではない</span>
            </div>
          </div>
          <div class="card card-red">
            <div class="icon-text">
              <span>&#x274C;</span>
              <span>Log Analytics ではログエントリの重複排除が行われないため、クエリの書き方に影響する場合がある</span>
            </div>
          </div>
          <div class="card card-red">
            <div class="icon-text">
              <span>&#x274C;</span>
              <span>linked BigQuery dataset を作成するとセキュリティ境界が拡大し、BigQuery サービスからもトレースデータにアクセス可能になる</span>
            </div>
          </div>
        </div>
        <div>
          <h3>&#x1F914; 考慮すべき点</h3>
          <div class="card card-orange">
            <div class="icon-text">
              <span>&#x1F4A1;</span>
              <span>既存のシンクベースのクエリは新しいスキーマに合わせて書き換えが必要 (例: <code>span.spanId</code> を <code>span_id</code> に変更)</span>
            </div>
          </div>
          <div class="card card-orange">
            <div class="icon-text">
              <span>&#x1F4A1;</span>
              <span>既存の BigQuery データセットに蓄積された履歴データは Log Analytics からは直接アクセスできないため、履歴データの保持計画を検討する必要がある</span>
            </div>
          </div>
          <div class="card card-orange">
            <div class="icon-text">
              <span>&#x1F4A1;</span>
              <span>トレースシンクで使用していた自動化スクリプトや CI/CD パイプラインの更新が必要になる場合がある</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Use Cases -->
    <div class="section">
      <h2>&#x1F4A1; ユースケース</h2>

      <div class="usecase-card">
        <h4>&#x1F3AF; ユースケース 1: マイクロサービスのレイテンシ分析</h4>
        <p><strong>シナリオ:</strong> マイクロサービスアーキテクチャで、サービス間のレイテンシをトレースデータから集計・分析したい</p>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">SQL</span>
            <span class="code-title">Log Analytics でのレイテンシ分析クエリ</span>
          </div>
          <pre><code class="language-sql">SELECT
  name AS span_name,
  COUNT(*) AS span_count,
  AVG(duration_nano) / 1e6 AS avg_duration_ms,
  APPROX_QUANTILES(duration_nano / 1e6, 100)[OFFSET(50)] AS p50_ms,
  APPROX_QUANTILES(duration_nano / 1e6, 100)[OFFSET(95)] AS p95_ms,
  APPROX_QUANTILES(duration_nano / 1e6, 100)[OFFSET(99)] AS p99_ms
FROM `PROJECT_ID.us._Trace.Spans._AllSpans`
WHERE parent_span_id IS NULL
GROUP BY name
ORDER BY span_count DESC
LIMIT 100</code></pre>
        </div>
        <p><strong>効果:</strong> シンクの設定やデータセットの管理なしに、Log Analytics から直接 SQL でレイテンシ分布を分析できる</p>
      </div>

      <div class="usecase-card">
        <h4>&#x1F50D; ユースケース 2: トレースデータとログデータの統合分析</h4>
        <p><strong>シナリオ:</strong> エラーが発生したトレースに関連するログエントリを同時に確認し、根本原因を特定したい</p>
        <p><strong>効果:</strong> Log Analytics の統合 SQL インターフェースを使用して、トレーススパンとログエントリを同一のクエリ環境で横断的に分析でき、インシデント対応時間を短縮できる</p>
      </div>
    </div>

    <!-- Pricing -->
    <div class="section">
      <h2>&#x1F4B0; 料金</h2>
      <p>Cloud Trace 自体の料金体系はトレースシンクの非推奨化によって変更されない。移行による料金への影響は以下の通り:</p>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>項目</th>
              <th>シンクベース (従来)</th>
              <th>Log Analytics (移行後)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>トレースエクスポート</td>
              <td>Cloud Trace の課金なし</td>
              <td>N/A (エクスポート不要)</td>
            </tr>
            <tr>
              <td>BigQuery ストリーミング</td>
              <td>BigQuery Streaming API の料金が発生</td>
              <td>N/A (ストリーミング不要)</td>
            </tr>
            <tr>
              <td>BigQuery ストレージ</td>
              <td>エクスポート先データセットのストレージ料金</td>
              <td>Observability バケットに含まれる</td>
            </tr>
            <tr>
              <td>クエリ実行</td>
              <td>BigQuery オンデマンドクエリ料金</td>
              <td>Log Analytics のデフォルトエンジンは追加料金なし</td>
            </tr>
            <tr>
              <td>linked dataset クエリ</td>
              <td>N/A</td>
              <td>BigQuery reserved slots を使用する場合は追加料金</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Related Services -->
    <div class="section">
      <h2>&#x1F310; 関連サービス・機能</h2>
      <div class="service-tags">
        <div class="service-tag">&#x1F4CA; Cloud Logging / Log Analytics</div>
        <div class="service-tag">&#x1F5C4;&#xFE0F; BigQuery</div>
        <div class="service-tag">&#x1F4C8; Cloud Monitoring</div>
        <div class="service-tag">&#x1F50D; OpenTelemetry</div>
        <div class="service-tag">&#x1F50E; Trace Explorer</div>
      </div>

      <div class="card">
        <div class="icon-text"><span class="arrow">&#x2192;</span><span><strong>Cloud Logging / Log Analytics:</strong> トレースデータの移行先となる SQL クエリインターフェース。トレースとログの統合分析基盤</span></div>
      </div>
      <div class="card">
        <div class="icon-text"><span class="arrow">&#x2192;</span><span><strong>BigQuery:</strong> linked BigQuery dataset を通じてトレースデータにアクセス可能。他のビジネスデータとの JOIN や Looker Studio での可視化に使用</span></div>
      </div>
      <div class="card">
        <div class="icon-text"><span class="arrow">&#x2192;</span><span><strong>Cloud Monitoring:</strong> トレースデータと連携してアラートポリシーの設定やダッシュボードの作成が可能</span></div>
      </div>
      <div class="card">
        <div class="icon-text"><span class="arrow">&#x2192;</span><span><strong>OpenTelemetry:</strong> Cloud Trace のトレーシングクライアントとして推奨。Log Analytics のスキーマは OpenTelemetry の仕様に準拠</span></div>
      </div>
      <div class="card">
        <div class="icon-text"><span class="arrow">&#x2192;</span><span><strong>Trace Explorer:</strong> 個別のトレースやスパンの閲覧・探索に使用。Log Analytics とは異なり、集計分析ではなく詳細な調査に適している</span></div>
      </div>
    </div>

    <!-- Summary -->
    <div class="section">
      <h2>&#x1F4DD; まとめ</h2>
      <div class="success-box">
        <p>Cloud Trace のトレースシンク機能は 2026 年 2 月 18 日から非推奨となり、<strong>Log Analytics</strong> への移行が推奨される。既存のシンクベースエクスポートを使用しているユーザーは、Log Analytics での <code>_Trace.Spans._AllSpans</code> ビューへのアクセスを確認し、既存のクエリをスキーマの違いに合わせて書き換えた上で、トレースシンクを削除する移行手順を計画・実行すべきである。</p>
        <p>Log Analytics は SQL ベースの統合クエリ環境を提供し、トレースとログの横断的な分析を可能にするため、Observability の運用基盤として長期的にはより優れた選択肢となる。</p>
      </div>

      <div class="flow-diagram">
        <div class="flow-step">&#x1F50D; アクセス確認<br/><small>Log Analytics</small></div>
        <span class="flow-arrow">&#x2192;</span>
        <div class="flow-step">&#x1F4DD; クエリ書き換え<br/><small>スキーマ対応</small></div>
        <span class="flow-arrow">&#x2192;</span>
        <div class="flow-step">&#x1F5D1;&#xFE0F; シンク削除<br/><small>gcloud CLI</small></div>
        <span class="flow-arrow">&#x2192;</span>
        <div class="flow-step">&#x2705; 移行完了<br/><small>Log Analytics</small></div>
      </div>
    </div>

    <!-- References -->
    <div class="section">
      <h2>&#x1F4CE; 参考リンク</h2>
      <ul class="links-list">
        <li>&#x1F4D6; <a href="https://cloud.google.com/release-notes#February_17_2026" target="_blank" rel="noopener noreferrer">公式リリースノート</a></li>
        <li>&#x1F504; <a href="https://cloud.google.com/trace/docs/analytics-migrate" target="_blank" rel="noopener noreferrer">シンクベースエクスポートからの移行ガイド</a></li>
        <li>&#x1F50D; <a href="https://cloud.google.com/trace/docs/analytics" target="_blank" rel="noopener noreferrer">Log Analytics でのトレースクエリ</a></li>
        <li>&#x1F517; <a href="https://cloud.google.com/trace/docs/analytics-query-linked-dataset" target="_blank" rel="noopener noreferrer">linked BigQuery dataset でのクエリ</a></li>
        <li>&#x1F4E6; <a href="https://cloud.google.com/trace/docs/trace-export-overview" target="_blank" rel="noopener noreferrer">トレースシンクの概要 (非推奨)</a></li>
        <li>&#x2699;&#xFE0F; <a href="https://cloud.google.com/trace/docs/trace-export-configure" target="_blank" rel="noopener noreferrer">トレースシンクの設定 (非推奨)</a></li>
        <li>&#x1F4B0; <a href="https://cloud.google.com/products/observability/pricing" target="_blank" rel="noopener noreferrer">Cloud Trace 料金</a></li>
      </ul>
    </div>

    <!-- Footer -->
    <footer>
      <p>&#x1F4CE; 出典: <a href="https://cloud.google.com/release-notes#February_17_2026" target="_blank" rel="noopener noreferrer">https://cloud.google.com/release-notes#February_17_2026</a></p>
      <p>#CloudTrace #Observability #CloudLogging #BigQuery #LogAnalytics #Deprecation #Migration</p>
    </footer>

  </div>

  <!-- Mermaid.js -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: 'base',
      themeVariables: {
        primaryColor: '#4285F4',
        primaryTextColor: '#202124',
        primaryBorderColor: '#4285F4',
        lineColor: '#4285F4',
        secondaryColor: '#F1F3F4',
        tertiaryColor: '#FAFAFA',
        background: '#FFFFFF',
        mainBkg: '#E8F0FE',
        nodeBorder: '#4285F4',
        clusterBkg: '#E8F0FE',
        clusterBorder: '#4285F4',
        edgeLabelBackground: '#FFFFFF',
        textColor: '#202124'
      }
    });
  </script>

  <!-- highlight.js -->
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
</body>
</html>