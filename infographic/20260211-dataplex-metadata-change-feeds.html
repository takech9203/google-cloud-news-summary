<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dataplex: Metadata Change Feeds - Google Cloud News Infographic</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap');

    :root {
      --gc-blue: #4285F4;
      --gc-red: #EA4335;
      --gc-yellow: #FBBC04;
      --gc-green: #34A853;
      --gc-blue-900: #174EA6;
      --gc-blue-800: #185ABC;
      --gc-blue-700: #1967D2;
      --gc-blue-600: #1A73E8;
      --gc-blue-500: #4285F4;
      --gc-blue-300: #669DF6;
      --gc-blue-200: #8AB4F8;
      --gc-blue-100: #AECBFA;
      --gc-blue-50: #E8F0FE;
      --gc-on-surface: #202124;
      --gc-on-surface-variant: #5F6368;
      --gc-outline: #80868B;
      --gc-surface: #FFFFFF;
      --gc-surface-container-lowest: #F8F9FA;
      --gc-surface-container-low: #F1F3F4;
      --gc-surface-container: #E8EAED;
      --gc-outline-variant: #DADCE0;
      --gc-blue-tint: #E8F0FE;
      --gc-green-tint: #E6F4EA;
      --gc-red-tint: #FCE8E6;
      --gc-yellow-tint: #FEF7E0;
      --gc-purple-tint: #F3E8FD;
      --gc-teal-tint: #E0F7FA;
      --gc-purple: #A142F4;
      --gc-teal: #00BCD4;
      --gc-orange: #FF6D00;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background-color: var(--gc-surface);
      font-family: 'Google Sans', 'Noto Sans JP', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      color: var(--gc-on-surface-variant);
      font-size: 16px;
      line-height: 1.7;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      width: 100%;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 32px;
      flex-wrap: wrap;
      padding-bottom: 16px;
      border-bottom: 3px solid var(--gc-blue-600);
    }

    .header-left { flex: 1; min-width: 280px; }

    h1 {
      font-size: 36px;
      font-weight: 700;
      color: var(--gc-on-surface);
      margin: 0 0 8px 0;
      line-height: 1.3;
    }

    .header-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    h2 {
      font-size: 24px;
      font-weight: 600;
      color: var(--gc-on-surface);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--gc-blue-600);
    }

    h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--gc-on-surface);
      margin: 16px 0 8px 0;
    }

    .subtitle {
      font-size: 16px;
      color: var(--gc-outline);
    }

    .section {
      background: var(--gc-surface-container-low);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid var(--gc-outline-variant);
    }

    .highlight {
      background-color: var(--gc-blue-50);
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      color: var(--gc-blue-800);
      border-bottom: 2px solid var(--gc-blue-600);
    }

    .card {
      background: var(--gc-surface);
      border-radius: 12px;
      padding: 20px;
      margin: 12px 0;
      border-left: 4px solid var(--gc-blue-600);
      box-shadow: 0 1px 3px rgba(60, 64, 67, 0.12), 0 1px 2px rgba(60, 64, 67, 0.08);
    }

    .icon-text {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin: 8px 0;
      color: var(--gc-on-surface-variant);
    }

    .badge, .badge-ga, .badge-preview, .badge-deprecated {
      display: inline-block;
      color: #FFFFFF;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.25px;
      margin: 4px 8px 4px 0;
    }

    .badge { background: var(--gc-blue-600); }
    .badge-ga { background: var(--gc-green); color: #FFFFFF; }

    /* Before/After */
    .before-after { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0; }
    .before-box {
      background: var(--gc-red-tint);
      border-left: 4px solid var(--gc-red);
      border-radius: 0 12px 12px 0;
      padding: 16px 20px;
    }
    .after-box {
      background: var(--gc-green-tint);
      border-left: 4px solid var(--gc-green);
      border-radius: 0 12px 12px 0;
      padding: 16px 20px;
    }
    .before-box strong, .after-box strong { display: block; margin-bottom: 8px; font-size: 15px; }

    /* Stat cards */
    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 16px 0; }
    .stat-card {
      background: linear-gradient(135deg, var(--gc-blue-600), var(--gc-blue-800));
      color: var(--gc-surface);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
    }
    .stat-value { font-size: 36px; font-weight: 700; margin-bottom: 4px; }
    .stat-label { font-size: 14px; opacity: 0.9; }

    /* Feature cards */
    .feature-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin: 16px 0; }
    .feature-card {
      background: var(--gc-surface);
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid var(--gc-blue-600);
      box-shadow: 0 1px 3px rgba(60, 64, 67, 0.12), 0 1px 2px rgba(60, 64, 67, 0.08);
    }
    .feature-card h4 {
      color: var(--gc-on-surface);
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .feature-card p { font-size: 14px; color: var(--gc-on-surface-variant); margin: 0; }

    /* Usecase cards */
    .usecase-card {
      background: var(--gc-blue-tint);
      border-radius: 12px;
      padding: 20px;
      margin: 12px 0;
      border: 1px solid var(--gc-blue-200);
    }
    .usecase-card h4 {
      color: var(--gc-blue-900);
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--gc-outline-variant);
    }
    th {
      background: var(--gc-blue-50);
      color: var(--gc-blue-900);
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      border-bottom: 2px solid var(--gc-blue-200);
    }
    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--gc-outline-variant);
      font-size: 14px;
    }
    tr:nth-child(even) { background: var(--gc-surface-container-lowest); }
    tr:hover { background: var(--gc-blue-50); }

    /* Note/Warning boxes */
    .note-box {
      background: var(--gc-blue-tint);
      border-left: 4px solid var(--gc-blue-600);
      padding: 16px 20px;
      border-radius: 0 12px 12px 0;
      margin: 16px 0;
    }
    .warning-box {
      background: var(--gc-yellow-tint);
      border-left: 4px solid var(--gc-yellow);
      padding: 16px 20px;
      border-radius: 0 12px 12px 0;
      margin: 16px 0;
    }

    /* Flow diagram */
    .flow-diagram {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
      margin: 24px 0;
    }
    .flow-step {
      background: var(--gc-surface);
      border: 2px solid var(--gc-blue-600);
      border-radius: 12px;
      padding: 12px 20px;
      text-align: center;
      min-width: 100px;
      color: var(--gc-on-surface);
      box-shadow: 0 1px 3px rgba(60, 64, 67, 0.12);
    }
    .flow-arrow {
      color: var(--gc-blue-600);
      font-size: 24px;
      font-weight: bold;
    }

    /* Mermaid container */
    .mermaid-container {
      background: #FFFFFF;
      border-radius: 12px;
      padding: 24px;
      margin: 20px 0;
      border: 2px solid rgba(66, 133, 244, 0.3);
      overflow-x: auto;
    }
    .mermaid {
      display: flex;
      justify-content: center;
    }

    /* Code blocks */
    .code-block {
      background: #1E1E1E;
      border-radius: 8px;
      overflow: hidden;
      margin: 16px 0;
    }
    .code-header {
      background: #2D2D2D;
      padding: 8px 16px;
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }
    .code-lang { color: #9CDCFE; font-weight: bold; }
    .code-title { color: #AAAAAA; }
    .code-block pre {
      margin: 0;
      padding: 0;
      overflow-x: auto;
      background: #1E1E1E;
      border-radius: 0;
    }
    .code-block code {
      font-family: 'Roboto Mono', 'Source Code Pro', 'Courier New', monospace;
      font-size: 15px;
      line-height: 1.6;
      padding: 16px !important;
    }

    pre:not(.mermaid) {
      background: #1E1E1E;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Roboto Mono', 'Source Code Pro', 'Courier New', monospace;
      font-size: 15px;
      line-height: 1.6;
      overflow-x: auto;
      color: #E8E8E8;
      margin: 16px 0;
    }
    pre code {
      background: none;
      border: none;
      padding: 0;
      font-size: inherit;
      color: inherit;
    }

    code:not(pre code) {
      background: var(--gc-surface-container-low);
      border: 1px solid var(--gc-outline-variant);
      border-radius: 4px;
      padding: 2px 6px;
      font-family: 'Roboto Mono', 'Source Code Pro', 'Courier New', monospace;
      font-size: 0.9em;
      color: var(--gc-blue-900);
    }

    .gc-link {
      color: var(--gc-blue-600);
      text-decoration: none;
    }
    .gc-link:hover {
      color: var(--gc-blue-800);
      text-decoration: underline;
    }

    /* Check items */
    .check-item { display: flex; align-items: flex-start; gap: 8px; margin: 8px 0; }
    .check-icon { color: var(--gc-green); font-size: 18px; flex-shrink: 0; }
    .cross-icon { color: var(--gc-red); font-size: 18px; flex-shrink: 0; }

    /* Two-column grid for merits/demerits */
    .two-col-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0; }

    /* Related services */
    .related-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin: 16px 0; }
    .related-card {
      background: var(--gc-surface);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--gc-outline-variant);
      box-shadow: 0 1px 2px rgba(60, 64, 67, 0.08);
    }
    .related-card strong { color: var(--gc-on-surface); font-size: 14px; }
    .related-card p { font-size: 13px; margin: 4px 0 0 0; color: var(--gc-on-surface-variant); }

    /* Cost table highlight */
    .cost-section { margin: 16px 0; }

    footer {
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid var(--gc-outline-variant);
      font-size: 12px;
      color: var(--gc-outline);
    }
    footer a { color: var(--gc-blue-600); text-decoration: underline; word-break: break-all; }
    footer ul { list-style: none; padding: 0; margin: 8px 0; }
    footer li { margin: 4px 0; }

    @media (max-width: 768px) {
      h1 { font-size: 26px; }
      h2 { font-size: 20px; }
      .before-after { grid-template-columns: 1fr; }
      .stat-grid { grid-template-columns: 1fr; }
      .two-col-grid { grid-template-columns: 1fr; }
      .header { flex-direction: column; }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
</head>
<body>
  <div class="container">

    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <h1>&#9729;&#65039; Dataplex: Metadata Change Feeds</h1>
        <div class="header-meta">
          <span class="badge">Dataplex Universal Catalog</span>
          <span class="badge-ga">GA</span>
          <span class="subtitle">2026-02-11</span>
        </div>
      </div>
    </div>

    <!-- Overview -->
    <div class="section">
      <h2>&#128203; 概要</h2>
      <p>Dataplex Universal Catalog に <span class="highlight">Metadata Change Feeds</span> 機能が GA (一般提供) として追加されました。メタデータ変更 (エントリやアスペクトの作成、更新、削除) を<strong>ほぼリアルタイム</strong>で追跡し、指定した Pub/Sub トピックに通知メッセージを発行できます。</p>
      <p style="margin-top: 12px;">データガバナンスとカタログ管理におけるイベント駆動型ワークフローの構築を実現する重要な機能です。外部カタログへのメタデータ同期、セキュリティポリシーの自動適用、データ品質チェックのトリガー、ETL/ELT ジョブの自動起動、コンプライアンス監査のためのメタデータ変更ログの記録といったユースケースに対応します。</p>
      <p style="margin-top: 12px;">対象ユーザーは<strong>データガバナンスチーム</strong>、<strong>データエンジニア</strong>、<strong>プラットフォームエンジニア</strong>であり、特に大規模なデータ基盤においてメタデータの変更をリアクティブに処理する必要がある組織にとって大きな価値があります。</p>
    </div>

    <!-- Stats -->
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-value">3~10 分</div>
        <div class="stat-label">ターゲットレイテンシ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">At Least Once</div>
        <div class="stat-label">配信保証</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">3 種類</div>
        <div class="stat-label">スコープ (組織 / プロジェクト / エントリグループ)</div>
      </div>
    </div>

    <!-- Before / After -->
    <div class="section">
      <h2>&#128260; Before / After</h2>
      <div class="before-after">
        <div class="before-box">
          <strong>&#10060; アップデート前の課題</strong>
          <div class="check-item"><span class="cross-icon">&#10005;</span><span>メタデータ変更検知には Dataplex API の定期ポーリングが必要で、リアルタイム性に欠けていた</span></div>
          <div class="check-item"><span class="cross-icon">&#10005;</span><span>バッチ処理ベースの同期では変更検知から対応までにタイムラグが発生</span></div>
          <div class="check-item"><span class="cross-icon">&#10005;</span><span>イベント駆動型ワークフローを構築する標準的な手段が未提供</span></div>
          <div class="check-item"><span class="cross-icon">&#10005;</span><span>外部カタログとの同期は手動またはカスタムスクリプトに依存</span></div>
        </div>
        <div class="after-box">
          <strong>&#9989; アップデート後の改善</strong>
          <div class="check-item"><span class="check-icon">&#10003;</span><span>Pub/Sub を介したほぼリアルタイムの通知 (ターゲットレイテンシ: 3~10 分)</span></div>
          <div class="check-item"><span class="check-icon">&#10003;</span><span>スコープとフィルターによる柔軟な通知制御</span></div>
          <div class="check-item"><span class="check-icon">&#10003;</span><span>Cloud Functions, Dataflow, Cloud Run などとシームレスに連携</span></div>
          <div class="check-item"><span class="check-icon">&#10003;</span><span>VPC Service Controls に準拠したセキュリティ境界内での追跡</span></div>
        </div>
      </div>
    </div>

    <!-- Architecture Diagram (Mermaid) -->
    <div class="section">
      <h2>&#128736;&#65039; アーキテクチャ図</h2>
      <p>Dataplex Universal Catalog でエントリやアスペクトが変更されると、Metadata Change Feed がスコープとフィルターに基づいて変更を検知し、Pub/Sub トピックに通知メッセージを発行します。下流のサービスがこの通知を受け取り、それぞれのユースケースに応じた処理を実行します。</p>
      <div class="mermaid-container">
        <pre class="mermaid">
flowchart LR
    subgraph Dataplex["Dataplex Universal Catalog"]
        Entry["Entry\n(データアセット)"]
        Aspect["Aspect\n(メタデータ)"]
        Feed["Metadata Change Feed\nスコープ + フィルター"]
    end

    Entry -->|CREATE / UPDATE / DELETE| Feed
    Aspect -->|CREATE / UPDATE / DELETE| Feed
    Feed -->|通知メッセージ| PubSub[/"Pub/Sub Topic"/]

    PubSub --> CF["Cloud Functions\nポリシー適用"]
    PubSub --> DF["Dataflow\nETL トリガー"]
    PubSub --> CR["Cloud Run\n外部カタログ同期"]
    PubSub --> BQ[("BigQuery\n監査ログ")]
        </pre>
      </div>
    </div>

    <!-- Key Features -->
    <div class="section">
      <h2>&#9889; 主要機能</h2>
      <div class="feature-grid">
        <div class="feature-card">
          <h4>&#127919; スコープベースのモニタリング</h4>
          <p>組織全体 (<code>organizationLevel: true</code>)、特定のプロジェクト、または特定のエントリグループをモニタリング対象として指定可能。API リソース名形式: <code>projects/PROJECT_ID/locations/LOCATION/metadataFeeds/FEED_ID</code></p>
        </div>
        <div class="feature-card">
          <h4>&#128269; フィルターによる通知の精緻化</h4>
          <p>エントリタイプ (例: <code>bigquery-table</code>)、アスペクトタイプ、変更タイプ (<code>CREATE</code>, <code>UPDATE</code>, <code>DELETE</code>) によるフィルタリング。フィルター未指定の場合はスコープ内のすべての変更タイプで通知が発行されます。</p>
        </div>
        <div class="feature-card">
          <h4>&#128233; 構造化された通知メッセージ</h4>
          <p>Pub/Sub メッセージの属性にタイムスタンプ、エントリ名、エントリタイプ、変更タイプなどの情報を含有。データペイロードには変更されたアスペクトの詳細リストを格納。Pub/Sub サブスクリプションフィルターによるさらなる絞り込みも可能。</p>
        </div>
        <div class="feature-card">
          <h4>&#128274; VPC Service Controls 対応</h4>
          <p>組織スコープの場合、VPC-SC 境界内のプロジェクトのみが通知を生成。プロジェクトまたはエントリグループスコープの場合、すべてのリソースが同一の VPC-SC 境界内に存在する必要があります。</p>
        </div>
        <div class="feature-card">
          <h4>&#128296; CRUD 操作による管理</h4>
          <p>REST API を通じた Metadata Change Feed の作成、表示、一覧取得、更新、削除が可能。スコープやフィルターの事後変更にも対応。</p>
        </div>
      </div>
    </div>

    <!-- Technical Specs -->
    <div class="section">
      <h2>&#128202; 技術仕様</h2>
      <h3>Metadata Change Feed の構成要素</h3>
      <table>
        <thead>
          <tr><th>項目</th><th>詳細</th></tr>
        </thead>
        <tbody>
          <tr><td>リソース名形式</td><td><code>projects/PROJECT_ID/locations/LOCATION/metadataFeeds/FEED_ID</code></td></tr>
          <tr><td>スコープ</td><td>組織全体、プロジェクト (複数指定可)、エントリグループ (複数指定可)</td></tr>
          <tr><td>フィルター</td><td>エントリタイプ、アスペクトタイプ、変更タイプ (<code>CREATE</code>, <code>UPDATE</code>, <code>DELETE</code>)</td></tr>
          <tr><td>送信先</td><td>Pub/Sub トピック (<code>projects/PROJECT_ID/topics/TOPIC_ID</code>)</td></tr>
          <tr><td>配信保証</td><td>At least once (重複メッセージの処理が必要)</td></tr>
          <tr><td>メッセージ順序</td><td>順序保証なし</td></tr>
          <tr><td>ターゲットレイテンシ</td><td>3~10 分</td></tr>
          <tr><td>有効化遅延</td><td>作成・更新後、最大 10 分で有効化</td></tr>
        </tbody>
      </table>

      <h3 style="margin-top: 24px;">通知メッセージの属性</h3>
      <table>
        <thead>
          <tr><th>属性名</th><th>説明</th></tr>
        </thead>
        <tbody>
          <tr><td><code>timestamp</code></td><td>変更が発生した時刻</td></tr>
          <tr><td><code>entry_name</code></td><td>エントリのリソース名</td></tr>
          <tr><td><code>entry_fqn</code></td><td>エントリの完全修飾名</td></tr>
          <tr><td><code>feed_name</code></td><td>Metadata Change Feed のリソース名</td></tr>
          <tr><td><code>entry_type</code></td><td>エントリタイプのリソース名</td></tr>
          <tr><td><code>entry_change_type</code></td><td>変更タイプ (<code>CREATED</code>, <code>UPDATED</code>, <code>DELETED</code>)</td></tr>
        </tbody>
      </table>

      <h3 style="margin-top: 24px;">Metadata Change Feed の設定例</h3>
      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">JSON</span>
          <span class="code-title">プロジェクトスコープの設定例</span>
        </div>
        <pre><code class="language-json">{
  "scope": {
    "projects": [
      "projects/PROJECT_ID_1",
      "projects/PROJECT_ID_2"
    ]
  },
  "filter": {
    "entryTypes": [
      "projects/PROJECT_ID/locations/global/entryTypes/bigquery-table"
    ],
    "changeTypes": [
      "CREATE",
      "UPDATE"
    ]
  },
  "pubsubTopic": "projects/PROJECT_ID_PUBSUB/topics/TOPIC_ID"
}</code></pre>
      </div>

      <h3 style="margin-top: 24px;">必要な IAM ロールと権限</h3>
      <table>
        <thead>
          <tr><th>対象</th><th>ロール</th><th>説明</th></tr>
        </thead>
        <tbody>
          <tr><td>ユーザー</td><td><code>roles/dataplex.entryGroupExporter</code></td><td>メタデータのエクスポート権限</td></tr>
          <tr><td>ユーザー</td><td><code>roles/pubsub.subscriber</code></td><td>Pub/Sub メッセージの受信権限</td></tr>
          <tr><td>Dataplex サービスアカウント</td><td><code>roles/pubsub.publisher</code></td><td>Pub/Sub トピックへのメッセージ発行権限</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Setup Steps -->
    <div class="section">
      <h2>&#128295; 設定方法</h2>

      <div class="note-box">
        <strong>&#128161; 前提条件:</strong> Dataplex Universal Catalog API と Pub/Sub API が有効化済み、通知受信用の Pub/Sub トピックが作成済み、<code>gcloud</code> CLI がインストール済みであること。
      </div>

      <h3>ステップ 1: Dataplex サービスアカウントに Pub/Sub Publisher ロールを付与</h3>
      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">Bash</span>
          <span class="code-title">IAM ポリシーバインディング</span>
        </div>
        <pre><code class="language-bash">gcloud pubsub topics add-iam-policy-binding TOPIC_ID \
    --member="serviceAccount:service-PROJECT_NUMBER@gcp-sa-dataplex.iam.gserviceaccount.com" \
    --role="roles/pubsub.publisher"</code></pre>
      </div>
      <p style="font-size: 14px; color: var(--gc-on-surface-variant); margin-top: 8px;">Dataplex サービスアカウント (<code>service-PROJECT_NUMBER@gcp-sa-dataplex.iam.gserviceaccount.com</code>) に対してロールを付与する点に注意。</p>

      <h3 style="margin-top: 20px;">ステップ 2: Metadata Change Feed を作成 (REST API)</h3>
      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">Bash</span>
          <span class="code-title">REST API による Feed 作成</span>
        </div>
        <pre><code class="language-bash"># gcurl エイリアスの設定
alias gcurl='curl -H "Authorization: Bearer $(gcloud auth print-access-token)" -H "Content-Type: application/json"'

# DATAPLEX_API 変数の設定
DATAPLEX_API="dataplex.googleapis.com/v1/projects/PROJECT_ID/locations/LOCATION"

# プロジェクトスコープで Metadata Change Feed を作成
gcurl -X POST -d '{
  "scope": {
    "projects": [
      "projects/PROJECT_ID_1",
      "projects/PROJECT_ID_2"
    ]
  },
  "filter": {
    "entryTypes": [
      "projects/PROJECT_ID/locations/global/entryTypes/bigquery-table"
    ]
  },
  "pubsubTopic": "projects/PROJECT_ID_PUBSUB/topics/TOPIC_ID"
}' "https://${DATAPLEX_API}/metadataFeeds?metadataFeedId=FEED_ID"</code></pre>
      </div>

      <h3 style="margin-top: 20px;">ステップ 3: Pub/Sub サブスクリプションを作成してメッセージを受信</h3>
      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">Bash</span>
          <span class="code-title">サブスクリプション作成とメッセージ確認</span>
        </div>
        <pre><code class="language-bash"># サブスクリプションの作成
gcloud pubsub subscriptions create SUBSCRIPTION_ID --topic=TOPIC_ID

# メッセージの確認 (テスト用)
gcloud pubsub subscriptions pull SUBSCRIPTION_ID --auto-ack --limit=10</code></pre>
      </div>
    </div>

    <!-- Merits & Demerits -->
    <div class="section">
      <h2>&#9878;&#65039; メリット・デメリット</h2>
      <div class="two-col-grid">
        <div>
          <h3>&#128994; ビジネス面のメリット</h3>
          <div class="check-item"><span class="check-icon">&#10003;</span><span><strong>データガバナンスの強化</strong>: メタデータ変更のリアルタイム追跡により、データカタログの鮮度と正確性が向上</span></div>
          <div class="check-item"><span class="check-icon">&#10003;</span><span><strong>コンプライアンス対応の効率化</strong>: メタデータ変更の自動監査ログにより、規制要件への対応コストを削減</span></div>
          <div class="check-item"><span class="check-icon">&#10003;</span><span><strong>運用コストの削減</strong>: ポーリングベースのカスタムスクリプトが不要になり、運用負荷が軽減</span></div>

          <h3 style="margin-top: 20px;">&#128994; 技術面のメリット</h3>
          <div class="check-item"><span class="check-icon">&#10003;</span><span><strong>イベント駆動アーキテクチャの実現</strong>: Pub/Sub を介した疎結合な設計で、柔軟かつスケーラブルなパイプラインを構築可能</span></div>
          <div class="check-item"><span class="check-icon">&#10003;</span><span><strong>きめ細かな制御</strong>: スコープとフィルターの組み合わせで、必要な変更通知のみを選択的に受信</span></div>
          <div class="check-item"><span class="check-icon">&#10003;</span><span><strong>セキュリティ境界の維持</strong>: VPC Service Controls との統合で、セキュリティポリシーを遵守</span></div>
        </div>
        <div>
          <h3>&#128308; 制限事項</h3>
          <div class="check-item"><span class="cross-icon">&#10005;</span><span>配信保証は "at least once" であり、サブスクライバー側で重複メッセージの処理 (冪等性の確保) が必要</span></div>
          <div class="check-item"><span class="cross-icon">&#10005;</span><span>メッセージの配信順序は保証されないため、順序依存の処理には追加ロジックが必要</span></div>
          <div class="check-item"><span class="cross-icon">&#10005;</span><span>ターゲットレイテンシは 3~10 分であり、厳密なリアルタイム性が求められるユースケースには不向き</span></div>
          <div class="check-item"><span class="cross-icon">&#10005;</span><span>通知ペイロードには変更シグネチャのみで、実際の変更データは含まれない。詳細は GetEntry API の追加呼び出しが必要</span></div>

          <h3 style="margin-top: 20px;">&#128308; 考慮すべき点</h3>
          <div class="check-item"><span class="cross-icon">&#10005;</span><span>Feed の作成・更新後、有効化まで最大 10 分の遅延がある</span></div>
          <div class="check-item"><span class="cross-icon">&#10005;</span><span>組織スコープの場合、VPC-SC 境界外のプロジェクトの変更は通知されない</span></div>
          <div class="check-item"><span class="cross-icon">&#10005;</span><span>Pub/Sub のメッセージ配信コストが別途発生するため、大量変更がある環境ではコスト見積もりが必要</span></div>
        </div>
      </div>
    </div>

    <!-- Use Cases -->
    <div class="section">
      <h2>&#128161; ユースケース</h2>

      <div class="usecase-card">
        <h4>&#127760; ユースケース 1: 外部データカタログとのメタデータ同期</h4>
        <p><strong>シナリオ:</strong> 社内で Dataplex Universal Catalog と並行してサードパーティのデータカタログ (Apache Atlas、Alation など) を運用しており、メタデータの一貫性を維持する必要がある。</p>
        <div class="code-block" style="margin-top: 12px;">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <span class="code-title">組織スコープの設定例</span>
          </div>
          <pre><code class="language-json">{
  "scope": {
    "organizationLevel": true
  },
  "pubsubTopic": "projects/my-project/topics/metadata-sync-topic"
}</code></pre>
        </div>
        <p style="margin-top: 8px;">Pub/Sub トピックに Cloud Functions をサブスクライブし、変更通知を受信するたびに外部カタログの API を呼び出してメタデータを同期。手動同期やバッチジョブが不要になり、カタログ間の不整合を最小限に抑えることが可能。</p>
      </div>

      <div class="usecase-card">
        <h4>&#128270; ユースケース 2: スキーマ変更に基づくデータ品質チェックの自動トリガー</h4>
        <p><strong>シナリオ:</strong> BigQuery テーブルのスキーマが変更された際に、下流のパイプラインに影響が出る前にデータ品質チェックを自動実行したい。</p>
        <div class="code-block" style="margin-top: 12px;">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <span class="code-title">UPDATE フィルターの設定例</span>
          </div>
          <pre><code class="language-json">{
  "scope": {
    "projects": ["projects/data-warehouse-project"]
  },
  "filter": {
    "entryTypes": [
      "projects/data-warehouse-project/locations/global/entryTypes/bigquery-table"
    ],
    "changeTypes": ["UPDATE"]
  },
  "pubsubTopic": "projects/my-project/topics/schema-change-topic"
}</code></pre>
        </div>
        <p style="margin-top: 8px;">UPDATE 通知を受信した Cloud Functions が Dataplex のデータ品質スキャンをトリガーし、結果に基づいて下流パイプラインの一時停止やデータオーナーへのアラートを実行。スキーマ変更に起因するデータ品質問題を早期に検出可能。</p>
      </div>
    </div>

    <!-- Pricing -->
    <div class="section">
      <h2>&#128176; 料金</h2>
      <p>Dataplex Universal Catalog Metadata Change Feeds 自体には<span class="highlight">直接的な課金は発生しない</span>。ただし、使用するリソースに対して以下のコストが発生します。</p>
      <table>
        <thead>
          <tr><th>コスト要素</th><th>課金対象</th><th>参考</th></tr>
        </thead>
        <tbody>
          <tr><td>Pub/Sub メッセージ配信</td><td>メッセージ配信量に応じた従量課金</td><td><a href="https://cloud.google.com/pubsub/pricing" target="_blank" class="gc-link">Pub/Sub 料金ページ</a></td></tr>
          <tr><td>Pub/Sub ストレージ</td><td>未確認メッセージの保存量に応じた課金</td><td><a href="https://cloud.google.com/pubsub/pricing" target="_blank" class="gc-link">Pub/Sub 料金ページ</a></td></tr>
          <tr><td>データ転送 (Egress)</td><td>リージョン間データ転送が発生する場合</td><td><a href="https://cloud.google.com/vpc/network-pricing" target="_blank" class="gc-link">ネットワーク料金ページ</a></td></tr>
          <tr><td>Dataplex API 呼び出し</td><td>GetEntry API などの追加呼び出し</td><td><a href="https://cloud.google.com/dataplex/pricing" target="_blank" class="gc-link">Dataplex 料金ページ</a></td></tr>
        </tbody>
      </table>
    </div>

    <!-- Related Services -->
    <div class="section">
      <h2>&#128279; 関連サービス・機能</h2>
      <div class="related-grid">
        <div class="related-card">
          <strong>&#128236; <a href="https://cloud.google.com/pubsub" target="_blank" class="gc-link">Pub/Sub</a></strong>
          <p>通知メッセージの配信基盤。サブスクリプションフィルターによるメッセージのさらなる絞り込みも可能。</p>
        </div>
        <div class="related-card">
          <strong>&#9889; <a href="https://cloud.google.com/functions" target="_blank" class="gc-link">Cloud Functions</a></strong>
          <p>Pub/Sub トリガーにより、メタデータ変更に応じた軽量な処理 (ポリシー適用、アラート送信) を実行。</p>
        </div>
        <div class="related-card">
          <strong>&#127754; <a href="https://cloud.google.com/dataflow" target="_blank" class="gc-link">Dataflow</a></strong>
          <p>Pub/Sub からのストリーミング入力を処理し、大規模な ETL/ELT パイプラインの実行に利用可能。</p>
        </div>
        <div class="related-card">
          <strong>&#128640; <a href="https://cloud.google.com/run" target="_blank" class="gc-link">Cloud Run</a></strong>
          <p>Pub/Sub プッシュサブスクリプションで外部カタログとのメタデータ同期処理を実行。</p>
        </div>
        <div class="related-card">
          <strong>&#128200; <a href="https://cloud.google.com/bigquery" target="_blank" class="gc-link">BigQuery</a></strong>
          <p>メタデータ変更のモニタリング対象として最も一般的なデータソース。監査ログの保存先としても利用可能。</p>
        </div>
        <div class="related-card">
          <strong>&#128218; <a href="https://cloud.google.com/dataplex/docs/catalog-overview" target="_blank" class="gc-link">Dataplex Universal Catalog</a></strong>
          <p>メタデータ管理の基盤。エントリとアスペクトの管理、データリネージ、データ品質などの機能と連携。</p>
        </div>
      </div>
    </div>

    <!-- Summary -->
    <div class="section" style="background: var(--gc-blue-tint); border: 1px solid var(--gc-blue-200);">
      <h2>&#128221; まとめ</h2>
      <p>Dataplex Universal Catalog の Metadata Change Feeds は、データガバナンスとカタログ管理における<span class="highlight">イベント駆動型アプローチ</span>を実現する重要な機能です。ポーリングベースの監視からリアクティブな通知ベースの処理への移行により、メタデータ変更への対応速度と運用効率が大幅に向上します。</p>
      <div class="note-box" style="margin-top: 16px;">
        <strong>&#128161; 推奨アクション:</strong> データ基盤を運用する組織は、まず主要プロジェクトをスコープとした Metadata Change Feed を作成し、外部カタログ同期やデータ品質チェックの自動化から導入を開始することを推奨します。
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <p><strong>&#128206; 出典:</strong></p>
      <ul>
        <li><a href="https://cloud.google.com/release-notes#February_11_2026" target="_blank" rel="noopener noreferrer">Google Cloud 公式リリースノート (2026-02-11)</a></li>
        <li><a href="https://cloud.google.com/dataplex/docs/metadata-change-feeds-overview" target="_blank" rel="noopener noreferrer">Metadata Change Feeds 概要ドキュメント</a></li>
        <li><a href="https://cloud.google.com/dataplex/docs/receive-metadata-notifications" target="_blank" rel="noopener noreferrer">Metadata Change Feeds の設定ガイド</a></li>
        <li><a href="https://cloud.google.com/dataplex/docs/troubleshoot-metadata-change-feeds" target="_blank" rel="noopener noreferrer">Metadata Change Feeds のトラブルシューティング</a></li>
        <li><a href="https://cloud.google.com/dataplex/docs/catalog-overview" target="_blank" rel="noopener noreferrer">Dataplex Universal Catalog 概要</a></li>
        <li><a href="https://cloud.google.com/dataplex/pricing" target="_blank" rel="noopener noreferrer">Dataplex 料金ページ</a></li>
        <li><a href="https://cloud.google.com/pubsub/pricing" target="_blank" rel="noopener noreferrer">Pub/Sub 料金ページ</a></li>
      </ul>
      <p style="margin-top: 12px; font-size: 11px; color: var(--gc-outline);">#Dataplex #MetadataChangeFeeds #PubSub #DataGovernance #DataCatalog #EventDriven #DataQuality</p>
    </footer>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: 'base',
      themeVariables: {
        primaryColor: '#4285F4',
        primaryTextColor: '#202124',
        primaryBorderColor: '#4285F4',
        lineColor: '#4285F4',
        secondaryColor: '#F1F3F4',
        tertiaryColor: '#FAFAFA',
        background: '#FFFFFF',
        mainBkg: '#E8F0FE',
        nodeBorder: '#4285F4',
        clusterBkg: '#E8F0FE',
        clusterBorder: '#4285F4',
        edgeLabelBackground: '#FFFFFF',
        textColor: '#202124'
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
</body>
</html>